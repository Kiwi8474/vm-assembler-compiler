# MX-26301 Technical Specification

---

## 0. Table of Contents
- [1\. System Overview](#1-system-overview)
- [2\. Register File](#2-register-file)
- [3\. Memory Map](#3-memory-map)
- [4\. Instruction Set Architecture (ISA)](#4-instruction-set-architecture-isa)
    - [4.1 Instruction Format](#41-instruction-format)
    - [4.2 Opcodes](#42-opcodes)
- [5\. Hardware Interfacing (I/O)](#5-hardware-interfacing-io)
    - [5.1 Text Display (VRAM)](#51-text-display-vram)
    - [5.2 Input Ports](#52-input-ports)
    - [5.3](#53-output-ports)
- [6\. GPU Acceleration](#60-gpu-acceleration)
    - [6.1 Coordinate Packing](#61-coordinate-packing)
    - [6.2 Instruction Parameters](#62-instruction-parameters)

---

## 1. System Overview
- **Architecture:** 32-bit register-based virtual machine.
- **Design Goal:** The first 32-bit MX CPU. Contains a MX-26201 in its core along with integrated text graphics and a 640x480 256 color bitmap mode.
- **Double Word Size:** 32-bit (all registers and memory addresses are 32-bit wide).

## 2. Register File
The MX-26301 features 16 registers (r0 through r15)
- **r0 - R13:** General Purpose Registers. Used for arithmetic, logic and data storage.
- **r14:** Stack Pointer. Initialized to 0x0000AFFF, should be manually initialized to 0xFFFFFFFF after switching to 32-bit.
- **r15:** Program Counter. Points to the current instruction in memory. Initialized to 0x00000000.

## 3. Memory Map
The address space is 4 GiB (0x00000000 - 0xFFFFFFFF).
| Range | Name | Description | Usage |
| :--- | :--- | :--- | :--- |
| `0x00000000 - 0x000001FF` | **BIOS** | BIOS-ROM is loaded here | System boot routines |
| `0x00000200 - 0x000003FF` | **Boot Sector** | Sector 0 of disk gets loaded from BIOS | Initial boot code |
| `0x00000400 - 0x000FFFFF` | **General RAM** | 767 KiB storage | Early programs like a kernel or drivers |
| `0x00100000 - 0x0014B000` | **VRAM** | 300 KiB | 640x480 pixel resolution with 256 colors |
| `0x0014B001 - 0xFFFFBFFF` | **General RAM** | ~3.9989 GiB storage | Userspace and applications |
| `0xFFFFA000 - 0xFFFFFFFF` | **Stack** | 16 KiB | 2048 dwords |

## 4. Instruction Set Architecture (ISA)
### 4.1 Instruction Format
All instructions are 8 bytes (64 bits) long.
`[Opcode: 8b] [RegA: 4b][RegB: 4b] [RegC: 4b][unused: 4b] [mode: 8b] [Imm: 32b]`

### 4.2 Opcodes
| Op | Mnemonic | Description |
| :--- | :--- | :--- |
| 0x00 | nop | No operation |
| 0x01 | halt | Stops the CPU |
| 0x02 | jmp | Jump to **RegC**, value in **RegC** or **imm** |
| 0x03 | je | Jump to **RegC**, value in **RegC** or **imm** if **RegA** == **RegB** |
| 0x04 | jne | Jump to **RegC**, value in **RegC** or **imm** if **RegA** != **RegB** |
| 0x05 | jg | Jump to **RegC**, value in **RegC** or **imm** if **RegA** > **RegB** |
| 0x06 | jge | Jump to **RegC**, value in **RegC** or **imm** if **RegA** >= **RegB** |
| 0x07 | jl | Jump to **RegC**, value in **RegC** or **imm** if **RegA** < **RegB** |
| 0x08 | jle | Jump to **RegC**, value in **RegC** or **imm** if **RegA** <= **RegB** |
| 0x09 | call | Jump to a routine |
| 0x0A | ret | Return back from a routine |
| 0x0B | int | Trigger software interrupt via vector table |
| 0x0C | iret | Return from interrupt handler |
||||
| 0x11 | mov | **RegA** = **RegB**, value at address in **RegB** or **imm** |
| 0x12 | push | Push **RegA** onto stack |
| 0x13 | pop | Pop from stack int **RegA** |
||||
| 0x20 | add | **RegA** = **RegA** + **RegB**/**imm** |
| 0x21 | sub | **RegA** = **RegA** - **RegB**/**imm** |
| 0x22 | mul | **RegA** = **RegA** * **RegB**/**imm** |
| 0x23 | div | **RegA** = **RegA** / **RegB**/**imm** |
| 0x24 | mod | **RegA** = **RegA** % **RegB**/**imm** |
||||
| 0x30 | and | Bitwise AND between **RegA** and **RegB**/**imm** |
| 0x31 | or | Bitwise OR between **RegA** and **RegB**/**imm** |
| 0x32 | xor | Bitwise XOR between **RegA** and **RegB**/**imm** |
| 0x33 | not | Bitwise NOT of **RegA** |
||||
| 0x40 | shl | Bitwise left shift of **RegA** by **RegB**/**imm** bits |
| 0x41 | shr | Logical right shift of **RegA** by **RegB**/**imm** bits |
| 0x42 | sar | Arithmetic right shift of **RegA** (preserves sign bit) |
| 0x43 | rol | Rotate bits of **RegA** left by **RegB**/**imm** bits |
| 0x44 | ror | Rotate bits of **RegA** right by **RegB**/**imm** bits |
||||
| 0x50 | fadd | Floating point addition |
| 0x51 | fsub | Floating point subtraction |
| 0x52 | fmul | Floating point multiplication |
| 0x53 | fdiv | Floating point division |
| 0x54 | fmod | Floating point modulo |
||||
| 0x60 | fsqrt | Floating point square root of **RegA** |
| 0x61 | fsin | Floating point sinus of **RegA** |
| 0x62 | fcos | Floating point cosinus of **RegA** |
| 0x63 | fabs | Floating point absolute value of **RegA** |
| 0x64 | f2i | Convert float to integer |
| 0x65 | i2f | Convert integer to float |
||||
| 0x70 | gpuclear | Clears/Fills a rectangular area with color |
| 0x71 | gpublit | Copies image data from src to dest |
| 0x72 | gpurect | Draws a rectangular outline using color |
| 0x73 | gpuline | Draws a line between two points using color |
| 0x74 | gpurectfill | Draws a solid, filled rectangle using color |
| 0x75 | gpucirc | Draws a circular outline with radius and color |
| 0x76 | gpucircfill | Draws a solid, filled circle with radius and color |
||||
| 0x80 | time | Get system time in ms into **RegA** |
| 0x81 | wait | Wait time in ms from **RegA** |
| 0x82 | rand | Get a random 32 bit integer into **RegA** |
||||
| 0xF0 | out | Write data from **RegB** to port in **RegA** |
| 0xF1 | in | Get data from port in **RegB** to **RegA** |

## 5. Hardware Interfacing (I/O)
### 5.1 Text Display (VRAM)
The display is a 256 color 640x480 pixel grid. Writing a byte to `0x00100000 - 0x0014B000` will render the corresponding color in a 332-RGB format.

### 5.2 Input Ports
Accessed via the `in` instruction (**RegB** = Port, **RegA** = Received Data)

| Port | Name | Description |
| :--- | :--- | :--- |
| `0x01` | KEY | Get pressed key in ASCII |
| `0x02` | MOUSE_X | Mouse X coordinate (0-639) |
| `0x03` | MOUSE_Y | Mouse Y coordinate (0-479) |
| `0x04` | MOUSE_BTN | Mouse button state (1 = Pressed, 0 = Released) |
| `0xFF` | SYS_ID | Returns CPU model number |

### 5.3 Output Ports
Accessed via the `out` instruction (**RegA** = Port, **RegB** = Data)

| Port | Name | Description |
| :--- | :--- | :--- |
| `0x01` | DEBUG_CHAR | Prints **RegB** as ASCII character to stdout |
| `0x02` | DEBUG_UINT| Prints **RegB** as uint to stdout |
| `0x03` | DEBUG_INT | Prints **RegB** as int to stdout |
| `0x04` | DEBUG_HEX | Prints **RegB** as hex to stdout |
| `0x05` | DEBUG_FLOAT | Prints **RegB** as float to stdout |
| `0x10` | DISK_SECTOR | Sets the target sector for next disk operation |
| `0x11` | DISK_ADDRESS | Sets the memory address for next disk operation |
| `0x12` | DISK_CMD | Executes disk command (1: Load to RAM, 2: Save to disk) |
| `0x20` | VGA_CTRL | Sets the VGA mode (0: monochrome text, 1: 16 colors text, 2: 256 colors pixel) |
| `0x30` | BUZZ_FREQ | Sets the frequency of the buzzer |
| `0x31` | BUZZ_DUR | Sets the duration in ms of the buzzer |
| `0x32` | BUZZ_CTRL | Writing any value activates the buzzer |
| `0xFF` | CPU_BITWIDTH | Sets the bit width of the CPU. (0: 16 bit, 1: 32 bit). Also available in 16 bit mode |

## 6.0 GPU Acceleration
The GPU instructions (`0x70 - 0x76`) use packed registers to handle 2D coordinates efficiently.

### 6.1 Coordinate Packing
For all instructions requiring a point (X, Y), the coordinates must be packed into a single 32-bit register:

- **Bits 31-16:** X-coordinate (0-639)
- **Bits 15-0:** Y-coordinate (0-479)

### 6.2 Instruction Parameters

| Instruction | RegA | RegB | RegC |
| :--- | :--- | :--- | :--- |
| **gpuclear / gpurectfill** | Top-Left (X,Y) | Bottom-Right (X,Y) | Color (0-255) |
| **gpuline / gpurect** | Start/Top-Left (X,Y) | End/Bottom-Right (X,Y) | Color (0-255) |
| **gpucirc / gpucircfill** | Center (X,Y) | Radius (0-0xFFFF) | Color (0-255) |
| **gpublit** | Source Address | Destination Address | Size (Width, Height)* |

*Note: Size in gpublit is also packed: (Width << 16 | Height).

---

### MX-Technologies Inc. | R&D Division | Lead Architect: [Kiwi8474](https://github.com/Kiwi8474)
